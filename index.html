<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Marcaci√≥n de Fotos ‚Äî PWA</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb;
      --accent:#22c55e; --accent-2:#3b82f6; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1024,#0f172a);color:var(--fg)}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    h1{font-size:clamp(1.25rem,2.5vw,1.8rem);margin:0 0 12px;display:flex;align-items:center;gap:10px}
    p.small{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:rgba(17,24,39,.7);backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:.9rem;margin:10px 0 6px 2px;color:#cbd5e1}
    input[type="text"],input[type="number"],input[type="file"],input[type="datetime-local"],select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--fg);outline:none;font-family:inherit}
    input[type="range"]{width:100%}
    textarea{resize:vertical;min-height:60px}
    select:disabled{opacity:0.6;cursor:not-allowed}
    details summary{padding:8px 0;margin:8px 0}
    details[open] summary{margin-bottom:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,#374151,#1f2937);color:var(--fg);padding:10px 14px;border-radius:8px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    button.primary{background:linear-gradient(180deg,#1f2937,#111827);border:1px solid #374151}
    button.secondary{background:linear-gradient(180deg,#4b5563,#374151);border:1px solid #6b7280}
    button.danger{background:linear-gradient(180deg,#7f1d1d,#991b1b);border:1px solid #dc2626}
    .install{background:linear-gradient(180deg,#1f2937,#111827);border:1px solid #374151}
    .preview{width:100%;display:block;max-height:70vh;border-radius:12px;background:#000;object-fit:contain}
    .kv{display:flex;justify-content:space-between;gap:6px;color:#9ca3af;font-size:.85rem;margin-top:6px;flex-wrap:wrap}
    .chip{padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid rgba(148,163,184,.2);color:#cbd5e1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px;min-width:0}
    footer{margin-top:18px;color:#94a3b8;font-size:.85rem}
    .hint{font-size:.8rem;color:#93c5fd}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
  <!-- Estos enlaces se completan din√°micamente para mantener el archivo √∫nico -->
  <link id="manifestLink" rel="manifest" href="#">
  <link id="appleTouchIcon" rel="apple-touch-icon">
</head>
<body>
  <div class="wrap">
    <h1>
      Marcaci√≥n Fotos
      <button id="installBtn" class="install" style="display:none">Instalar</button>
    </h1>
    <p class="small">Registra y marca fotos con informaci√≥n del proyecto.</p>
    <p class="small" style="margin-top: 8px; color: #f59e0b;">Los campos marcados con (*) son obligatorios</p>

    <div class="grid">
      <section class="card">
        <!-- Fecha y hora de creaci√≥n (oculto) -->
        <input type="hidden" id="fechaCreacion">
        
        <!-- Fecha elegida por el usuario -->
        <label for="fecha">Fecha *</label>
        <input id="fecha" type="datetime-local" required />

        <!-- √Årea -->
        <label for="area">√Årea *</label>
        <select id="area" required>
          <option value="">Selecciona un √°rea...</option>
          <option value="T√∫nel Gr√∫a Puente">T√∫nel Gr√∫a Puente</option>
          <option value="Casa de M√°quinas">Casa de M√°quinas</option>
          <option value="Transformador">Transformador</option>
          <option value="Vertedero">Vertedero</option>
          <option value="Embalse">Embalse</option>
          <option value="Obra de Toma">Obra de Toma</option>
        </select>

        <!-- Frente (dependiente del √°rea) -->
        <label for="frente">Frente *</label>
        <select id="frente" required disabled>
          <option value="">Primero selecciona un √°rea</option>
        </select>

        <!-- Foto -->
        <label for="file">Fotograf√≠a *</label>
        <input id="file" type="file" accept="image/*" required />

        <!-- Descripci√≥n de la foto -->
        <label for="descripcionFoto">Descripci√≥n de la fotograf√≠a *</label>
        <textarea id="descripcionFoto" rows="2" placeholder="Ej: Vaciado de concreto en t√∫nel" required></textarea>

        <!-- Observaciones -->
        <label for="observaciones">Observaciones</label>
        <textarea id="observaciones" rows="3" placeholder="Observaciones adicionales (opcional)"></textarea>

        <!-- Configuraci√≥n de marca de agua (colapsable) -->
        <details style="margin-top:15px">
          <summary style="cursor:pointer;color:var(--muted);font-weight:400;font-size:0.85rem">‚öô Opciones adicionales</summary>
          <div style="margin-top:10px">
            <div class="row">
              <div>
                <label for="fontSize">Tama√±o texto (px)</label>
                <input id="fontSize" type="number" value="36" min="8" max="200" />
              </div>
              <div>
                <label for="opacity">Opacidad: <span id="opacityVal">0.4</span></label>
                <input id="opacity" type="range" min="0.3" max="1" step="0.01" value="0.4" />
              </div>
            </div>
            <div class="row">
              <div>
                <label for="position">Posici√≥n marca de agua</label>
                <select id="position">
                  <option value="br">Abajo-Derecha</option>
                  <option value="bl">Abajo-Izquierda</option>
                  <option value="tl">Arriba-Izquierda</option>
                  <option value="tr">Arriba-Derecha</option>
                </select>
              </div>
              <div>
                <label for="rotation">Rotaci√≥n imagen</label>
                <select id="rotation">
                  <option value="0">0¬∞ (auto)</option>
                  <option value="90">90¬∞</option>
                  <option value="180">180¬∞</option>
                  <option value="270">270¬∞</option>
                </select>
              </div>
            </div>
          </div>
        </details>

        <div class="btns">
          <button class="secondary" id="btnPreview">Previsualizar</button>
          <button class="primary" id="btnProcess">Procesar y Guardar</button>
          <button class="danger" id="btnClear">Limpiar</button>
        </div>

        <p class="small" style="margin-top:10px">üì∑ La foto se guardar√° autom√°ticamente en Google Drive con marca de agua.</p>
      </section>

      <section class="card">
        <canvas id="canvas" class="preview" aria-label="Vista previa"></canvas>
        <div class="kv">
          <div class="chip" id="infoDim">‚Äî</div>
          <div class="chip" id="infoSize">‚Äî</div>
          <div class="chip" id="infoName">‚Äî</div>
        </div>
        <div class="btns">
          <a id="downloadLink" download style="display:none"><button class="primary">Descargar imagen</button></a>
        </div>
      </section>
    </div>

    <footer>Sistema de marcaci√≥n de fotos - Versi√≥n 1.0</footer>
  </div>

  <!-- PWA: manifest + SW generados al vuelo -->
  <script>
    (function(){
      function makeIcon(size){
        const c=document.createElement('canvas'); c.width=c.height=size; const x=c.getContext('2d');
        x.fillStyle='#0f172a'; x.fillRect(0,0,size,size);
        const g=x.createLinearGradient(0,0,size,size); g.addColorStop(0,'#22c55e'); g.addColorStop(1,'#3b82f6');
        x.fillStyle=g; x.beginPath(); x.arc(size/2,size/2,size*0.44,0,Math.PI*2); x.fill();
        x.fillStyle='#fff'; x.font=`${Math.round(size*0.28)}px system-ui, sans-serif`; x.textAlign='center'; x.textBaseline='middle';
        x.fillText('WM', size/2, size/2);
        return c.toDataURL('image/png');
      }
      const icon192 = makeIcon(192);
      const icon512 = makeIcon(512);

      const manifest = {
        name: 'Marcaci√≥n de Fotos',
        short_name: 'MarcaFotos',
        description: 'Registra y marca fotos con informaci√≥n del proyecto, local y offline.',
        start_url: './',
        scope: './',
        display: 'standalone',
        background_color: '#0f172a',
        theme_color: '#0f172a',
        icons: [{ src: icon192, sizes:'192x192', type:'image/png' }, { src: icon512, sizes:'512x512', type:'image/png' }]
      };
      const murl = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/json'}));
      document.getElementById('manifestLink').href = murl;
      document.getElementById('appleTouchIcon').href = icon192;

      const swCode = `
        const CACHE_NAME='wm-pwa-v1';
        const CORE=self.registration.scope?[self.registration.scope]:['/'];
        self.addEventListener('install',e=>{
          e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(CORE)).then(()=>self.skipWaiting()));
        });
        self.addEventListener('activate',e=>{
          e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k)))) .then(()=>self.clients.claim()));
        });
        self.addEventListener('fetch',e=>{
          const req=e.request;
          if(req.mode==='navigate'||(req.method==='GET'&&req.headers.get('accept')?.includes('text/html'))){
            e.respondWith(fetch(req).then(r=>{const copy=r.clone(); caches.open(CACHE_NAME).then(c=>c.put(req,copy)); return r;})
              .catch(()=>caches.match(req).then(r=>r||caches.match('/'))));
            return;
          }
          if(req.method==='GET'){
            e.respondWith(caches.match(req).then(cached=>{
              const fetchP=fetch(req).then(net=>{caches.open(CACHE_NAME).then(c=>c.put(req,net.clone())); return net;}).catch(()=>cached);
              return cached||fetchP;
            }));
          }
        });
      `;
      // ServiceWorker deshabilitado temporalmente para evitar errores en GitHub Pages
      // if('serviceWorker' in navigator && location.protocol === 'https:'){
      //   const swUrl=URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
      //   navigator.serviceWorker.register(swUrl).catch(console.error);
      // }

      let deferredPrompt=null;
      const installBtn=document.getElementById('installBtn');
      window.addEventListener('beforeinstallprompt',(e)=>{
        e.preventDefault(); deferredPrompt=e; installBtn.style.display='inline-flex';
      });
      installBtn?.addEventListener('click', async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt=null; installBtn.style.display='none';
      });
    })();
  </script>

  <!-- L√ìGICA DE LA APP -->
  <script>
    const $=(id)=>document.getElementById(id);
    const fileEl=$("file"), fechaCreacionEl=$("fechaCreacion"), fechaEl=$("fecha"),
          areaEl=$("area"), frenteEl=$("frente"), descripcionFotoEl=$("descripcionFoto"),
          observacionesEl=$("observaciones"), positionEl=$("position"), fontSizeEl=$("fontSize"),
          opacityEl=$("opacity"), opacityVal=$("opacityVal"), rotationEl=$("rotation"),
          btnPreview=$("btnPreview"), btnProcess=$("btnProcess"), btnClear=$("btnClear"),
          canvas=$("canvas"), ctx=canvas.getContext("2d"),
          infoDim=$("infoDim"), infoSize=$("infoSize"), infoName=$("infoName"),
          downloadLink=$("downloadLink");
    
    // URL del Google Apps Script
    const GAS_URL = 'https://script.google.com/a/macros/sedic.com.co/s/AKfycbwb-1q2Rd4TBxL5GDDMzc3PL9lkKuy3VIPOWw67bKvwH4oh6yoCmAa46UqJWY75G612/exec';
    
    // Configuraci√≥n de √°reas y frentes (se cargar√° din√°micamente)
    let areasFrentes = {};

    // Event listeners
    opacityEl.addEventListener('input',()=>opacityVal.textContent=opacityEl.value);
    
    // Funci√≥n para obtener fecha/hora de Bogot√° usando la API nativa
    function getBogotaTime() {
      // Usar la API de zona horaria nativa del navegador
      const now = new Date();
      const bogotaTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Bogota"}));
      return bogotaTime;
    }
    
    function getBogotaDateTimeForInput() {
      // Para el input datetime-local, crear la fecha directamente en formato local
      const now = new Date();
      
      // Obtener los componentes de fecha/hora en zona horaria de Bogot√°
      const bogotaFormatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/Bogota',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      
      const parts = bogotaFormatter.formatToParts(now);
      const year = parts.find(p => p.type === 'year').value;
      const month = parts.find(p => p.type === 'month').value;
      const day = parts.find(p => p.type === 'day').value;
      const hour = parts.find(p => p.type === 'hour').value;
      const minute = parts.find(p => p.type === 'minute').value;
      
      return `${year}-${month}-${day}T${hour}:${minute}`;
    }
    
    function getBogotaISOString() {
      return getBogotaTime().toISOString();
    }
    
    // Mostrar hora actual de Bogot√° en la consola para verificaci√≥n
    const bogotaTimeString = new Date().toLocaleString('es-CO', {
      timeZone: 'America/Bogota',
      year: 'numeric',
      month: '2-digit', 
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    console.log('üïê Hora actual de Bogot√°:', bogotaTimeString);
    
    // Inicializar fechas con zona horaria de Bogot√°
    fechaCreacionEl.value = getBogotaISOString();
    fechaEl.value = getBogotaDateTimeForInput();
    
    // Cargar √°reas y frentes desde la base de datos
    loadAreasFromSheets();
    
    // Manejar cambio de √°rea
    areaEl.addEventListener('change', ()=>{
      const area = areaEl.value;
      frenteEl.innerHTML = '<option value="">Selecciona un frente...</option>';
      
      if(area && areasFrentes[area]){
        frenteEl.disabled = false;
        areasFrentes[area].forEach(frente => {
          const option = document.createElement('option');
          option.value = frente;
          option.textContent = frente;
          frenteEl.appendChild(option);
        });
      } else {
        frenteEl.disabled = true;
        frenteEl.innerHTML = '<option value="">Primero selecciona un √°rea</option>';
      }
    });

    let loadedImg=null;

    fileEl.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const url=URL.createObjectURL(f); const img=new Image();
      await new Promise((res,rej)=>{img.onload=res; img.onerror=rej; img.src=url;});
      loadedImg={image:img,width:img.naturalWidth,height:img.naturalHeight,name:f.name,size:f.size};
      infoDim.textContent=`${img.naturalWidth}√ó${img.naturalHeight}px`;
      infoSize.textContent=humanSize(f.size);
      infoName.textContent=f.name;
      updateFilename();
      drawPreview();
    });

    // Actualizar nombre de archivo cuando cambien los campos
    frenteEl.addEventListener('change', updateFilename);
    descripcionFotoEl.addEventListener('input', updateFilename);
    fechaEl.addEventListener('change', updateFilename);

    btnPreview.addEventListener('click',(e)=>{e.preventDefault(); drawPreview();});
    
    btnProcess.addEventListener('click', async (e)=>{
      e.preventDefault();
      if(!validateForm()) return;
      
      // Mostrar indicador de procesamiento
      btnProcess.textContent = 'Procesando...';
      btnProcess.disabled = true;
      
      try {
        // Actualizar fecha de creaci√≥n al momento exacto del procesamiento (hora de Bogot√°)
        fechaCreacionEl.value = getBogotaISOString();
        
        // Procesar imagen con marca de agua
        await drawPreview(true);
        const filename = generateFilename();
        const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
        
        // Convertir blob a base64
        const imageBase64 = await blobToBase64(blob);
        
        // Preparar datos para env√≠o
        const formData = {
          fechaCreacion: fechaCreacionEl.value,
          fecha: fechaEl.value,
          area: areaEl.value,
          frente: frenteEl.value,
          descripcionFoto: descripcionFotoEl.value,
          observaciones: observacionesEl.value,
          filename: filename,
          imageBase64: imageBase64
        };
        
        console.log('üìã Datos preparados para env√≠o:', {
          fechaCreacion: formData.fechaCreacion,
          fecha: formData.fecha,
          area: formData.area,
          frente: formData.frente,
          descripcionFoto: formData.descripcionFoto,
          observaciones: formData.observaciones,
          filename: formData.filename,
          imageSize: formData.imageBase64 ? (formData.imageBase64.length / 1024).toFixed(1) + 'KB' : 'No image'
        });
        
        // Enviar a Google Apps Script
        const response = await sendToGAS(formData);
        
        if (response.success) {
          // √âxito: mostrar enlace de descarga local tambi√©n
          const dl = URL.createObjectURL(blob);
          downloadLink.href = dl;
          downloadLink.download = `${filename}.jpg`;
          downloadLink.style.display = 'inline-block';
          downloadLink.querySelector('button').textContent = `Descargar ${filename}.jpg`;
          setTimeout(()=>URL.revokeObjectURL(dl), 60000);
          
          showSuccessModal(response.data.fileName, response.data.driveUrl);
          
          // Limpiar formulario despu√©s del √©xito
          btnClear.click();
          
        } else {
          throw new Error(response.message || 'Error desconocido del servidor');
        }
        
      } catch (error) {
        console.error('Error procesando foto:', error);
        
        // En caso de error, ofrecer descarga local
        await drawPreview(true);
        const filename = generateFilename();
        const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
        const dl = URL.createObjectURL(blob);
        downloadLink.href = dl;
        downloadLink.download = `${filename}.jpg`;
        downloadLink.style.display = 'inline-block';
        downloadLink.querySelector('button').textContent = `Descargar ${filename}.jpg (Error en env√≠o)`;
        setTimeout(()=>URL.revokeObjectURL(dl), 60000);
        
        showErrorModal(error.message);
      } finally {
        // Restaurar bot√≥n
        btnProcess.textContent = 'Procesar y Guardar';
        btnProcess.disabled = false;
      }
    });
    
    btnClear.addEventListener('click',(e)=>{
      e.preventDefault(); 
      // Limpiar formulario
      fileEl.value=''; 
      fechaEl.value = getBogotaDateTimeForInput(); // Usar funci√≥n de Bogot√°
      areaEl.value='';
      frenteEl.value='';
      frenteEl.disabled=true;
      descripcionFotoEl.value='';
      observacionesEl.value='';
      
      // Limpiar imagen
      loadedImg=null; 
      ctx.clearRect(0,0,canvas.width,canvas.height);
      infoDim.textContent='‚Äî'; 
      infoSize.textContent='‚Äî'; 
      infoName.textContent='‚Äî';
      downloadLink.style.display='none';
    });

    function baseName(name){ const dot=name.lastIndexOf('.'); return dot>-1?name.slice(0,dot):name; }
    function sanitize(str){ return str.trim().replace(/\s+/g,' ').replace(/[^a-zA-Z0-9\s\-]/g,''); }
    function humanSize(bytes){ const u=['B','KB','MB','GB']; let i=0,n=bytes; while(n>=1024&&i<u.length-1){n/=1024;i++;} return `${n.toFixed(1)} ${u[i]}`; }
    
    function validateForm(){
      if(!fechaEl.value){ 
        showValidationModal('Por favor selecciona una fecha', fechaEl); 
        return false; 
      }
      if(!areaEl.value){ 
        showValidationModal('Por favor selecciona un √°rea', areaEl); 
        return false; 
      }
      if(!frenteEl.value){ 
        showValidationModal('Por favor selecciona un frente', frenteEl); 
        return false; 
      }
      if(!loadedImg){ 
        showValidationModal('Por favor selecciona una imagen', fileEl); 
        return false; 
      }
      if(!descripcionFotoEl.value.trim()){ 
        showValidationModal('Por favor ingresa una descripci√≥n de la foto', descripcionFotoEl); 
        return false; 
      }
      return true;
    }
    
    function generateFilename(){
      const fecha = new Date(fechaEl.value);
      const yyyymmdd = fecha.toISOString().slice(0,10).replace(/-/g,'');
      const frente = sanitize(frenteEl.value);
      const descripcion = sanitize(descripcionFotoEl.value);
      return `${yyyymmdd}-${frente}-${descripcion}`;
    }
    
    function updateFilename(){
      if(fechaEl.value && frenteEl.value && descripcionFotoEl.value.trim()){
        const filename = generateFilename();
        infoName.textContent = `${filename}.jpg`;
      }
    }
    
    function formatDateTime(dateStr){
      // Convertir el datetime-local a fecha de Bogot√°
      // dateStr viene en formato "YYYY-MM-DDTHH:MM"
      const [datePart, timePart] = dateStr.split('T');
      const [year, month, day] = datePart.split('-');
      const [hours, minutes] = timePart.split(':');
      
      // Crear fecha en zona horaria de Bogot√° (sin conversi√≥n autom√°tica del navegador)
      const formattedDay = day.padStart(2,'0');
      const formattedMonth = month.padStart(2,'0');
      const formattedHours = hours.padStart(2,'0');
      const formattedMinutes = minutes.padStart(2,'0');
      
      return `${formattedDay}/${formattedMonth}/${year} ${formattedHours}:${formattedMinutes}`;
    }
    
    // Convertir blob a base64
    function blobToBase64(blob){
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }
    
    // Cargar √°reas y frentes desde Google Sheets usando JSONP
    async function loadAreasFromSheets(){
      try {
        console.log('üîÑ Intentando cargar √°reas desde Sheets (JSONP)...');
        
        const data = await loadAreasWithJSONP();
        
        if (data && data.success && data.data) {
          areasFrentes = data.data;
          populateAreaSelect();
          console.log('‚úÖ √Åreas cargadas exitosamente desde Sheets:', Object.keys(areasFrentes));
          return;
        } else {
          console.warn('‚ö†Ô∏è Respuesta no exitosa desde GAS');
        }
      } catch (error) {
        console.error('‚ùå Error cargando √°reas:', error);
      }
      
      // Fallback: usar configuraci√≥n est√°tica
      console.log('üîÑ Usando configuraci√≥n por defecto...');
      areasFrentes = {
        "T√∫nel Gr√∫a Puente": ["T√∫nel Norte", "T√∫nel Sur", "Gr√∫a Puente Norte", "Gr√∫a Puente Sur"],
        "Casa de M√°quinas": ["Casa de M√°quinas Norte", "Casa de M√°quinas Sur", "Turbina 1", "Turbina 2", "Generador 1", "Generador 2"],
        "Transformador": ["Transformador Principal", "Transformador Auxiliar", "Patio de Maniobras"],
        "Vertedero": ["Vertedero Principal", "Canal de Descarga", "Compuertas"],
        "Embalse": ["Presa", "Coronamiento", "Talud Aguas Arriba", "Talud Aguas Abajo"],
        "Obra de Toma": ["Rejillas", "Compuertas de Toma", "T√∫nel de Conducci√≥n"]
      };
      populateAreaSelect();
      console.log('‚úÖ Configuraci√≥n por defecto aplicada');
    }
    
    // Funci√≥n JSONP para cargar √°reas sin problemas de CORS
    function loadAreasWithJSONP() {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        
        // Crear funci√≥n callback global temporal
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        
        // Crear script tag
        const script = document.createElement('script');
        script.src = GAS_URL + '?action=getAreas&callback=' + callbackName;
        
        // Manejar errores
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          reject(new Error('Error cargando script JSONP'));
        };
        
        // Timeout
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('Timeout JSONP'));
          }
        }, 10000);
        
        // Agregar script al DOM
        document.body.appendChild(script);
      });
    }
    
    // Poblar select de √°reas
    function populateAreaSelect(){
      console.log('üèóÔ∏è Poblando select de √°reas...');
      areaEl.innerHTML = '<option value="">Selecciona un √°rea...</option>';
      
      const areas = Object.keys(areasFrentes);
      console.log('üìã √Åreas disponibles:', areas);
      
      areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        areaEl.appendChild(option);
        console.log(`‚ûï √Årea agregada: ${area}`);
      });
      
      console.log(`‚úÖ ${areas.length} √°reas agregadas al select`);
    }

    // Enviar datos a Google Apps Script
    async function sendToGAS(data){
      try {
        console.log('üì§ Enviando datos a GAS:', {
          filename: data.filename,
          area: data.area,
          frente: data.frente,
          descripcion: data.descripcionFoto,
          imageSize: (data.imageBase64.length / 1024).toFixed(1) + 'KB'
        });
        
        const form = new FormData();
        form.append('data', JSON.stringify(data));
        
        console.log('üöÄ Enviando a GAS URL:', GAS_URL);
        
        const response = await fetch(GAS_URL, {
          method: 'POST',
          body: form,
          mode: 'no-cors' // Evitar problemas de CORS
        });
        
        // Con no-cors no podemos leer la respuesta directamente
        // Pero si llega aqu√≠ sin error, el env√≠o fue exitoso
        console.log('‚úÖ Datos enviados a GAS exitosamente');
        
        return { 
          success: true, 
          message: 'Foto enviada correctamente a Google Drive',
          data: { 
            fileName: data.filename + '.jpg',
            timestamp: new Date().toISOString()
          }
        };
        
      } catch (error) {
        console.error('‚ùå Error enviando a GAS:', error);
        throw new Error('Error de conexi√≥n: ' + error.message);
      }
    }



    async function drawPreview(final=false){
      if(!loadedImg) return;
      const img=loadedImg.image, rot=Number(rotationEl.value);
      let targetW=img.naturalWidth, targetH=img.naturalHeight;
      
      // Redimensionar si es muy grande (max 2000px de ancho)
      const maxW = 2000;
      if(targetW > maxW){ 
        const s=maxW/targetW; 
        targetW=Math.round(targetW*s); 
        targetH=Math.round(targetH*s); 
      }
      
      const needsSwap=rot===90||rot===270;
      canvas.width=needsSwap?targetH:targetW; 
      canvas.height=needsSwap?targetW:targetH;

      // Dibujar imagen
      ctx.save();
      if(rot!==0){
        if(rot===90){ctx.translate(canvas.width,0); ctx.rotate(Math.PI/2);}
        if(rot===180){ctx.translate(canvas.width,canvas.height); ctx.rotate(Math.PI);}
        if(rot===270){ctx.translate(0,canvas.height); ctx.rotate(3*Math.PI/2);}
      }
      ctx.drawImage(img,0,0,targetW,targetH);
      ctx.restore();

      // Crear marca de agua con informaci√≥n del formulario
      if(fechaEl.value && frenteEl.value && descripcionFotoEl.value){
        const fechaFormateada = formatDateTime(fechaEl.value);
        const frente = frenteEl.value;
        const descripcion = descripcionFotoEl.value;
        
        const watermarkLines = [fechaFormateada, frente, descripcion];
        drawWatermark(watermarkLines);
      }

      // Actualizar informaci√≥n
      infoDim.textContent=`${canvas.width}√ó${canvas.height}px`;
      const blob=await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.9));
      infoSize.textContent=humanSize(blob.size);
      updateFilename();
    }

    function drawWatermark(lines){
      const opacity=Number(opacityEl.value);
      const size=Number(fontSizeEl.value);
      const pos=positionEl.value;
      const margin=20;
      const lineHeight=size*1.2;
      const padding = 16;
      
      ctx.save();
      ctx.globalAlpha=opacity;
      ctx.fillStyle='rgba(0,0,0,0.7)'; // Fondo semitransparente
      ctx.font=`600 ${size}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`;
      
      // Calcular dimensiones del bloque de texto
      const maxWidth = Math.max(...lines.map(line => ctx.measureText(line).width));
      const blockWidth = maxWidth + (padding * 2);
      const blockHeight = (lines.length * lineHeight) + padding;
      
      // Calcular posici√≥n
      let x = margin, y = margin;
      if(pos==='br'){ x = canvas.width - blockWidth - margin; y = canvas.height - blockHeight - margin; }
      if(pos==='bl'){ x = margin; y = canvas.height - blockHeight - margin; }
      if(pos==='tr'){ x = canvas.width - blockWidth - margin; y = margin; }
      if(pos==='tl'){ x = margin; y = margin; }
      
      // Dibujar fondo redondeado
      roundRect(ctx, x, y, blockWidth, blockHeight, 8);
      ctx.fill();
      
      // Dibujar texto alineado a la derecha
      ctx.fillStyle='#ffffff';
      ctx.globalAlpha=Math.min(1, opacity + 0.3);
      ctx.textAlign = 'right'; // Alineaci√≥n a la derecha
      
      lines.forEach((line, index) => {
        const textY = y + padding + (index * lineHeight) + (size * 0.7);
        const textX = x + blockWidth - padding; // Posici√≥n X para alineaci√≥n derecha
        ctx.fillText(line, textX, textY);
      });
      
      ctx.restore();
    }

    function roundRect(ctx,x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
    }
    
    // Modales mejorados
    function showSuccessModal(fileName, driveUrl) {
      const modal = createModal(`
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; color: #22c55e; margin-bottom: 16px;">‚úì</div>
          <h3 style="color: #22c55e; margin: 0 0 16px 0; font-size: 1.2rem;">¬°Foto guardada exitosamente!</h3>
          <p style="margin: 8px 0; color: #94a3b8;">
            <strong>Archivo:</strong> ${fileName}<br>
            <strong>Ubicaci√≥n:</strong> Google Drive
          </p>
          ${driveUrl ? `<p style="margin: 16px 0;"><a href="${driveUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline;">üîó Ver archivo en Drive</a></p>` : ''}
          <button onclick="closeModal()" style="margin-top: 20px; padding: 8px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Aceptar
          </button>
        </div>
      `);
    }
    
    function showErrorModal(errorMessage) {
      const modal = createModal(`
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;">‚ö†</div>
          <h3 style="color: #ef4444; margin: 0 0 16px 0; font-size: 1.2rem;">Error al guardar</h3>
          <p style="margin: 8px 0; color: #94a3b8;">
            ${errorMessage}
          </p>
          <p style="margin: 16px 0; color: #f59e0b; font-size: 0.9rem;">
            üí° Puedes descargar la imagen localmente usando el bot√≥n de descarga
          </p>
          <button onclick="closeModal()" style="margin-top: 20px; padding: 8px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Cerrar
          </button>
        </div>
      `);
    }
    
    function showValidationModal(message, focusElement) {
      const modal = createModal(`
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; color: #f59e0b; margin-bottom: 16px;">‚Ñπ</div>
          <h3 style="color: #f59e0b; margin: 0 0 16px 0; font-size: 1.2rem;">Campo requerido</h3>
          <p style="margin: 8px 0; color: #94a3b8;">
            ${message}
          </p>
          <button onclick="closeModal(); focusField('${focusElement.id}')" style="margin-top: 20px; padding: 8px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Entendido
          </button>
        </div>
      `);
    }
    
    function focusField(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.focus();
        // Scroll al elemento si est√° fuera de vista
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    function createModal(content) {
      // Crear backdrop
      const backdrop = document.createElement('div');
      backdrop.id = 'modal-backdrop';
      backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
        z-index: 1000; animation: fadeIn 0.2s ease;
      `;
      
      // Crear modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: #111827; border-radius: 12px; border: 1px solid #374151;
        max-width: 400px; width: 90%; max-height: 90%; overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        animation: slideIn 0.3s ease;
      `;
      modal.innerHTML = content;
      
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
      
      // Cerrar al hacer clic en el backdrop
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) closeModal();
      });
      
      return modal;
    }
    
    function closeModal() {
      const backdrop = document.getElementById('modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
    }
    
    // Agregar estilos para las animaciones
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideIn { from { transform: scale(0.9) translateY(-10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
